<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nuestro Chat ğŸ’–</title>
    <style>
        :root { --primary: #ff4d6d; --secondary: #fff0f3; --text-dark: #590d22; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #fce4ec; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        #app { width: 100%; max-width: 450px; display: flex; flex-direction: column; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        #header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        #chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fff; }
        
        /* Burbujas y Contenedores */
        .msg-container { display: flex; flex-direction: column; position: relative; max-width: 85%; animation: fadeIn 0.3s ease; }
        .msg-container.me { align-self: flex-end; align-items: flex-end; }
        .msg-container.you { align-self: flex-start; align-items: flex-start; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .msg { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; }
        .me .msg { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .you .msg { background: var(--secondary); color: var(--text-dark); border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 10px; display: block; margin-top: 5px; }

        /* Borrado */
        .delete-btn { background: none; color: #bbb; border: none; font-size: 10px; cursor: pointer; margin-top: 2px; visibility: hidden; }
        .msg-container.me:hover .delete-btn { visibility: visible; }

        /* Indicador Escribiendo */
        #typing-indicator { 
            padding: 5px 15px; font-size: 12px; color: #888; font-style: italic; 
            height: 20px; background: white; border-top: 1px solid #f9f9f9;
        }

        /* Input y Emojis */
        #emoji-picker { display: none; grid-template-columns: repeat(6, 1fr); gap: 8px; padding: 15px; background: #fefefe; border-top: 1px solid #eee; }
        .emoji-item { font-size: 1.6rem; cursor: pointer; text-align: center; }
        #input-area { padding: 12px; background: #fff; border-top: 1px solid #eee; }
        .controls { display: flex; gap: 20px; margin-bottom: 10px; padding-left: 10px; }
        .icon-btn { cursor: pointer; font-size: 1.5em; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; border: 1px solid #ddd; padding: 12px; border-radius: 25px; outline: none; }
        button#sendBtn { background: var(--primary); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="header">â¤ï¸ Nuestro Espacio â¤ï¸</div>
    <div id="chat-box"></div>
    
    <div id="typing-indicator"></div> <div id="emoji-picker">
        <div class="emoji-item">â¤ï¸</div><div class="emoji-item">ğŸ˜˜</div><div class="emoji-item">ğŸ˜</div><div class="emoji-item">ğŸ˜Š</div><div class="emoji-item">âœ¨</div><div class="emoji-item">ğŸ”¥</div>
        <div class="emoji-item">ğŸ’–</div><div class="emoji-item">ğŸŒ¹</div><div class="emoji-item">ğŸ¥°</div><div class="emoji-item">ğŸ¤©</div><div class="emoji-item">ğŸ§¸</div><div class="emoji-item">ğŸ¤£</div>
    </div>
    <div id="input-area">
        <div class="controls">
            <span class="icon-btn" id="emojiBtn">ğŸ˜Š</span>
            <span class="icon-btn" onclick="document.getElementById('fileInput').click()">ğŸ“·</span>
        </div>
        <div class="input-row">
            <input type="file" id="fileInput" accept="image/*">
            <input type="text" id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
            <button id="sendBtn">â¤</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onChildRemoved, onValue, set, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyClp2tVcoeIE_ZOedIzP6zyEXEoP9Em0tM",
    authDomain: "chatpareja-3fbce.firebaseapp.com",
    databaseURL: "https://chatpareja-3fbce-default-rtdb.firebaseio.com",
    projectId: "chatpareja-3fbce",
    storageBucket: "chatpareja-3fbce.firebasestorage.app",
    messagingSenderId: "954583350974",
    appId: "1:954583350974:web:8a1b6dfdaddd1b54d728ef"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, 'messages');
  const typingRef = ref(db, 'typing');

  if(!localStorage.getItem('chat_id')) localStorage.setItem('chat_id', 'u' + Math.floor(Math.random() * 1000000));
  const myId = localStorage.getItem('chat_id');

  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('msgInput');
  const typingDiv = document.getElementById('typing-indicator');

  // --- LÃ“GICA DE "ESCRIBIENDO..." ---
  let typingTimeout;
  input.addEventListener('input', () => {
      // Decirle a Firebase que estoy escribiendo
      set(ref(db, 'typing/' + myId), { typing: true });

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
          // Borrar estado despuÃ©s de 2 segundos de inactividad
          remove(ref(db, 'typing/' + myId));
      }, 2000);
  });

  // Escuchar si la OTRA persona estÃ¡ escribiendo
  onValue(typingRef, (snapshot) => {
      const users = snapshot.val();
      let isSomeoneElseTyping = false;
      for (let id in users) {
          if (id !== myId) isSomeoneElseTyping = true;
      }
      typingDiv.textContent = isSomeoneElseTyping ? "Tu pareja estÃ¡ escribiendo..." : "";
  });

  // --- EMOJIS Y ENVÃO ---
  document.getElementById('emojiBtn').onclick = () => { document.getElementById('emoji-picker').style.display = document.getElementById('emoji-picker').style.display === 'grid' ? 'none' : 'grid'; };
  document.querySelectorAll('.emoji-item').forEach(el => { el.onclick = () => { input.value += el.innerText; input.focus(); }; });

  const send = () => {
    if(input.value.trim()) {
      remove(ref(db, 'typing/' + myId)); // Dejar de escribir al enviar
      push(chatRef, { userId: myId, text: input.value, type: 'text', time: serverTimestamp() });
      input.value = ''; document.getElementById('emoji-picker').style.display = 'none';
    }
  };
  document.getElementById('sendBtn').onclick = send;
  input.onkeypress = (e) => { if(e.key === 'Enter') send(); };

  // --- FOTOS ---
  document.getElementById('fileInput').onchange = (e) => {
    const file = e.target.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = (ev) => push(chatRef, { userId: myId, imageData: ev.target.result, type: 'image', time: serverTimestamp() });
        reader.readAsDataURL(file);
    }
  };

  // --- MANEJO DE MENSAJES ---
  window.deleteMsg = (key) => { if(confirm("Â¿Eliminar?")) remove(ref(db, 'messages/' + key)); };

  onChildAdded(chatRef, (snap) => {
    const data = snap.val();
    const key = snap.key;
    const container = document.createElement('div');
    container.className = `msg-container ${data.userId === myId ? 'me' : 'you'}`;
    container.id = 'msg-' + key;
    let content = data.type === 'image' ? `<img src="${data.imageData}">` : data.text;
    let del = data.userId === myId ? `<button class="delete-btn" onclick="deleteMsg('${key}')">Eliminar</button>` : '';
    container.innerHTML = `<div class="msg">${content}</div>${del}`;
    chatBox.appendChild(container);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  onChildRemoved(chatRef, (snap) => {
      const el = document.getElementById('msg-' + snap.key);
      if(el) el.remove();
  });
</script>
</body>
</html>
