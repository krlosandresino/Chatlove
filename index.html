<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestro Chat üíñ</title>
    <style>
        :root { --primary: #ff4d6d; --secondary: #fff0f3; --text-dark: #590d22; }
        body { font-family: 'Segoe UI', sans-serif; background: #fce4ec; margin: 0; display: flex; justify-content: center; height: 100vh; }
        #app { width: 100%; max-width: 450px; display: flex; flex-direction: column; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        #chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fff; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 75%; font-size: 15px; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .you { align-self: flex-start; background: var(--secondary); color: var(--text-dark); border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        
        #input-area { padding: 10px; display: flex; flex-direction: column; border-top: 1px solid #eee; }
        .controls { display: flex; gap: 12px; margin-bottom: 8px; font-size: 1.3em; padding-left: 5px; }
        .controls span { cursor: pointer; }
        
        .input-row { display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; border: 1px solid #eee; padding: 10px 15px; border-radius: 20px; outline: none; }
        button { background: var(--primary); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="header">‚ù§Ô∏è Nuestro Espacio Privado ‚ù§Ô∏è</div>
    <div id="chat-box"></div>
    <div id="input-area">
        <div class="controls">
            <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="addEmoji('üòò')">üòò</span>
            <span onclick="addEmoji('üòç')">üòç</span>
            <span onclick="document.getElementById('fileInput').click()">üì∑</span>
        </div>
        <div class="input-row">
            <input type="file" id="fileInput" accept="image/*">
            <input type="text" id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
            <button id="sendBtn">‚û§</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyClp2tVcoeIE_ZOedIzP6zyEXEoP9Em0tM",
    authDomain: "chatpareja-3fbce.firebaseapp.com",
    databaseURL: "https://chatpareja-3fbce-default-rtdb.firebaseio.com",
    projectId: "chatpareja-3fbce",
    storageBucket: "chatpareja-3fbce.firebasestorage.app",
    messagingSenderId: "954583350974",
    appId: "1:954583350974:web:8a1b6dfdaddd1b54d728ef"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, 'messages');

  if(!localStorage.getItem('chat_user_id')) {
      localStorage.setItem('chat_user_id', 'user_' + Math.floor(Math.random() * 1000000));
  }
  const myId = localStorage.getItem('chat_user_id');

  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('msgInput');
  const fileInput = document.getElementById('fileInput');

  // Enviar Texto
  document.getElementById('sendBtn').onclick = () => {
    if(input.value.trim()) {
      push(chatRef, { userId: myId, text: input.value, type: 'text', time: serverTimestamp() });
      input.value = '';
    }
  };

  // Enviar Foto (Convertida a Base64)
  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            push(chatRef, { 
                userId: myId, 
                imageData: event.target.result, 
                type: 'image', 
                time: serverTimestamp() 
            });
        };
        reader.readAsDataURL(file);
    }
  };

  // Mostrar Mensajes
  onChildAdded(chatRef, (snapshot) => {
    const data = snapshot.val();
    const div = document.createElement('div');
    div.className = `msg ${data.userId === myId ? 'me' : 'you'}`;
    
    if(data.type === 'image') {
        const img = document.createElement('img');
        img.src = data.imageData;
        div.appendChild(img);
    } else {
        div.textContent = data.text;
    }
    
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  window.addEmoji = (emoji) => { input.value += emoji; input.focus(); };
</script>
</body>
</html>
