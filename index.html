<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nuestro Chat con Audio üíñ</title>
    <style>
        :root { --primary: #ff4d6d; --secondary: #fff0f3; --text-dark: #590d22; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #fce4ec; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        #app { width: 100%; max-width: 450px; display: flex; flex-direction: column; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        #header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        #chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #fff; }
        
        .msg-container { display: flex; flex-direction: column; max-width: 85%; }
        .msg-container.me { align-self: flex-end; align-items: flex-end; }
        .msg-container.you { align-self: flex-start; align-items: flex-start; }

        .msg { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; position: relative; }
        .me .msg { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .you .msg { background: var(--secondary); color: var(--text-dark); border-bottom-left-radius: 2px; }
        
        audio { max-width: 220px; height: 35px; margin-top: 5px; }
        .me audio { filter: contrast(0.1) brightness(2); }

        #status-indicator { padding: 5px 15px; font-size: 12px; color: #ff4d6d; height: 25px; font-style: italic; }
        
        #input-area { padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .controls { display: flex; gap: 20px; margin-bottom: 8px; font-size: 1.5em; align-items: center; }
        .icon-btn { cursor: pointer; transition: 0.3s; }
        .recording-ui { color: #ff0000 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .input-row { display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; border: 1px solid #ddd; padding: 12px; border-radius: 25px; outline: none; }
        button#sendBtn { background: var(--primary); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="header">‚ù§Ô∏è Nuestro Espacio ‚ù§Ô∏è</div>
    <div id="chat-box"></div>
    
    <div id="status-indicator"></div>

    <div id="input-area">
        <div class="controls">
            <span class="icon-btn" onclick="document.getElementById('fileInput').click()">üì∑</span>
            <span class="icon-btn" id="micBtn">üéôÔ∏è</span>
            <span id="emojiBtn" style="cursor:pointer; font-size: 1.2em;">üòä</span>
        </div>
        <div class="input-row">
            <input type="file" id="fileInput" accept="image/*">
            <input type="text" id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
            <button id="sendBtn">‚û§</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onChildRemoved, set, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyClp2tVcoeIE_ZOedIzP6zyEXEoP9Em0tM",
    authDomain: "chatpareja-3fbce.firebaseapp.com",
    databaseURL: "https://chatpareja-3fbce-default-rtdb.firebaseio.com",
    projectId: "chatpareja-3fbce",
    storageBucket: "chatpareja-3fbce.firebasestorage.app",
    messagingSenderId: "954583350974",
    appId: "1:954583350974:web:8a1b6dfdaddd1b54d728ef"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, 'messages');
  const statusRef = ref(db, 'status'); // Nueva rama para estados

  const myId = localStorage.getItem('chat_id') || 'u' + Date.now();
  localStorage.setItem('chat_id', myId);

  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('msgInput');
  const statusDiv = document.getElementById('status-indicator');
  const micBtn = document.getElementById('micBtn');

  // --- ESTADOS: ESCRIBIENDO Y GRABANDO ---
  input.oninput = () => {
      set(ref(db, 'status/' + myId), { action: 'escribiendo' });
      clearTimeout(window.tOut);
      window.tOut = setTimeout(() => remove(ref(db, 'status/' + myId)), 2000);
  };

  onValue(statusRef, (snap) => {
      const data = snap.val();
      let statusText = "";
      for(let id in data) {
          if(id !== myId) {
              if(data[id].action === 'grabando') statusText = "Tu pareja est√° grabando audio... üéôÔ∏è";
              else if(data[id].action === 'escribiendo') statusText = "Tu pareja est√° escribiendo...";
          }
      }
      statusDiv.textContent = statusText;
  });

  // --- L√ìGICA DE AUDIO ---
  let mediaRecorder;
  let audioChunks = [];

  micBtn.onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
          try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              mediaRecorder = new MediaRecorder(stream);
              audioChunks = [];

              // Avisar que estoy GRABANDO
              set(ref(db, 'status/' + myId), { action: 'grabando' });

              mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
              mediaRecorder.onstop = () => {
                  const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                  const reader = new FileReader();
                  reader.readAsDataURL(audioBlob);
                  reader.onloadend = () => {
                      push(chatRef, { userId: myId, audioData: reader.result, type: 'audio', time: serverTimestamp() });
                      remove(ref(db, 'status/' + myId)); // Quitar estado
                  };
                  micBtn.classList.remove('recording-ui');
              };

              mediaRecorder.start();
              micBtn.classList.add('recording-ui');
          } catch (err) { alert("No se pudo acceder al micr√≥fono"); }
      } else {
          mediaRecorder.stop();
      }
  };

  // --- ENV√çO TEXTO ---
  const send = () => {
      if(input.value.trim()){
          push(chatRef, { userId: myId, text: input.value, type: 'text', time: serverTimestamp() });
          input.value = '';
          remove(ref(db, 'status/' + myId));
      }
  };
  document.getElementById('sendBtn').onclick = send;
  input.onkeypress = (e) => e.key === 'Enter' && send();

  // --- RECIBIR MENSAJES ---
  onChildAdded(chatRef, (snap) => {
    const data = snap.val();
    const key = snap.key;
    const container = document.createElement('div');
    container.className = `msg-container ${data.userId === myId ? 'me' : 'you'}`;
    container.id = 'msg-' + key;

    let content = data.type === 'audio' 
        ? `<audio controls src="${data.audioData}"></audio>` 
        : data.type === 'image' ? `<img src="${data.imageData}" style="max-width:100%; border-radius:10px;">` : data.text;

    container.innerHTML = `
        <div class="msg">${content}</div>
        ${data.userId === myId ? `<small style="cursor:pointer;color:#ccc;font-size:9px;" onclick="remove(ref(db,'messages/${key}'))">Eliminar</small>` : ''}
    `;
    chatBox.appendChild(container);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  onChildRemoved(chatRef, (snap) => document.getElementById('msg-' + snap.key)?.remove());
</script>
</body>
</html>
